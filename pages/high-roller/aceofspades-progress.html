<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Ace of Spades – Progress</title>
  <link rel="stylesheet" href="../../css/style.css">
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">
</head>

<body class="page-transition blackjack-bg">

<header>
  <nav class="mainnav">
    <ul>
      <li><a href="../../index.html">Home</a></li>
      <li><a href="../raider.html">Raider</a></li>
      <li><a href="../hollowsoul.html">Spettatori</a></li>
      <li><a href="../recruiting.html">Reclutamento</a></li>
      <li><a href="../statuto.html">Statuto</a></li>
    </ul>
  </nav>
</header>

<!-- SUBNAV ACE OF SPADES -->
<nav class="subnav">
  <ul>
    <li><a href="../high-roller/aceofspades.html">Home Team</a></li>
    <li><a href="../high-roller/roster-aceofspades.html">Roster</a></li>
    <li><a href="../high-roller/aceofspades-news.html">News</a></li>
    <li><a href="../high-roller/aceofspades-progress.html" class="active">Progress</a></li>
  </ul>
</nav>

<section class="hero">
  <div class="hero-content">
    <h2>Progress Ace of Spades</h2>
    <p>Avanzamento raid, recap sessioni e roster dell’ultima serata.</p>
  </div>
</section>

<div class="bg-container bg-aceofspades-logo">
  <main class="panel">

    <!-- PANORAMICA -->
    <h2 class="section-title">Panoramica per difficoltà</h2>
    <p class="section-subtitle">
      Stato del raid per Normal, Heroic e Mythic.
    </p>

    <div class="widgets-grid">

      <div class="widget-card">
        <h3 class="widget-title">Normal</h3>
        <div class="progress-content" id="card-normal">Sto caricando…</div>
      </div>

      <div class="widget-card">
        <h3 class="widget-title">Heroic</h3>
        <div class="progress-content" id="card-heroic">Sto caricando…</div>
      </div>

      <div class="widget-card">
        <h3 class="widget-title">Mythic</h3>
        <div class="progress-content" id="card-mythic">Sto caricando…</div>
      </div>

    </div>

    <!-- ULTIMA SESSIONE -->
    <div class="widget-full">
      <h2 class="section-title" id="last-session-title">
        Ultima sessione raid
      </h2>
      <p class="section-subtitle">
        Resoconto completo della serata Ace of Spades: kill, wipe e progress.
        Passa col mouse sui pallini per vedere i dettagli.
      </p>

      <!-- LIVE TWITCH -->
      <div id="live-raid-wrapper" class="live-raid-wrapper">
        <div class="live-raid-card" id="live-raid-card">
          <div class="live-status-pill live-status-offline" id="live-status-pill">
            <span class="live-dot"></span> Offline
          </div>
          <h3 class="widget-title">Diretta raid – Twitch</h3>
          <p class="live-description" id="live-description">
            La diretta verrà mostrata qui quando il canale sarà online.
          </p>
          <div class="live-player-shell" id="live-player-shell">
            <!-- iframe Twitch verrà inserito via JS -->
          </div>
        </div>
      </div>
      <!-- /LIVE TWITCH -->

      <div class="session-summary-card" id="last-session-summary">
        Caricamento in corso…
      </div>

      <div class="dot-timeline-container" id="dot-timeline"></div>

      <div class="text-center mt-20">
        <a id="last-session-report-link"
           href="#"
           target="_blank"
           class="apply-button hidden">
          Apri il report dell’ultima sessione
        </a>
      </div>

      <!-- ROSTER DALL'ULTIMO REPORT -->
      <div class="session-roster-card" id="live-roster-card">
        <h3 class="widget-title">Roster attuale</h3>
        <p class="section-subtitle section-subtitle--compact">
          Giocatori presenti nell’ultima sessione registrata su Warcraft Logs.
        </p>
        <div id="live-roster">Sto caricando il roster…</div>
      </div>

    </div>

  </main>
</div>

<footer>
  <p>&copy; 2025 Blackjack</p>
</footer>

<!-- TRANSITION -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  document.body.classList.add("page-loaded");
});
</script>

<!-- URL WORKERS -->
<script>
  const WORKER_FULL = "https://red-snowflake-a386.lucasantoro2905.workers.dev";
  const WORKER_LAST = "https://wild-mode-1b45.lucasantoro2905.workers.dev";

  /* LIVE TWITCH */
  const TWITCH_CHANNEL = "londe83";
  const WORKER_TWITCH = "https://tiny-fog-34d1.lucasantoro2905.workers.dev"; // cambia se usi un altro URL
</script>

<!-- PROGRESS LOGIC -->
<script>
async function loadDifficulty(diff, id) {
  try {
    const el = document.getElementById(id);
    const res = await fetch(`${WORKER_FULL}/progress-full?difficulty=${diff}`);
    const data = await res.json();

    const bosses = Object.keys(data.bosses || {});
    const killed = bosses.filter(b => data.bosses[b].kills > 0);
    const inProgress = bosses.filter(
      b => data.bosses[b].kills === 0 &&
           data.bosses[b].bestPercentage != null &&
           data.bosses[b].bestPercentage < 100
    );

    let html = `
      <strong>Kill:</strong> ${killed.length} / ${bosses.length}<br>
      <strong>Progress:</strong> ${inProgress.length}<br>
      <strong>Miglior try:</strong>
      ${inProgress.length ? Math.min(...inProgress.map(b => data.bosses[b].bestPercentage)) + "%" : "—"}
      <div class="boss-list">
    `;

    killed.forEach(b => html += `<span class="boss-killed">${b}</span>`);
    inProgress.forEach(b => html += `<span class="boss-progress">${b} (${data.bosses[b].bestPercentage}%)</span>`);

    html += "</div>";
    el.innerHTML = html;

  } catch (e) {
    document.getElementById(id).textContent = "Impossibile caricare i dati.";
  }
}

async function fetchLastSession() {
  const res = await fetch(`${WORKER_LAST}/progress-last`);
  return res.json();
}

/* ========= LIVE TWITCH ========= */
async function fetchTwitchLive() {
  const url = `${WORKER_TWITCH}/?channel=${encodeURIComponent(TWITCH_CHANNEL)}`;
  const res = await fetch(url, { cache: "no-store" });
  if (!res.ok) throw new Error("Errore worker Twitch");
  return res.json();
}

function renderTwitchLive(liveData) {
  const pill = document.getElementById("live-status-pill");
  const descr = document.getElementById("live-description");
  const shell = document.getElementById("live-player-shell");
  if (!pill || !descr || !shell) return;

  if (!liveData || !liveData.live) {
    pill.classList.remove("live-status-live");
    pill.classList.add("live-status-offline");
    pill.innerHTML = '<span class="live-dot"></span> Offline';
    descr.textContent = "Il canale Twitch è offline. La prossima diretta raid apparirà qui appena saremo live.";
    shell.innerHTML = "";
    return;
  }

  pill.classList.remove("live-status-offline");
  pill.classList.add("live-status-live");
  pill.innerHTML = '<span class="live-dot"></span> Live ora';

  const title = liveData.title || "Diretta raid Ace of Spades";
  const game = liveData.game_name;
  const viewers = liveData.viewer_count;

  let descText = title;
  if (game) descText += ` • Giocando: ${game}`;
  if (viewers != null) descText += ` • Viewers: ${viewers}`;
  descr.textContent = descText;

  const embed = `
    <iframe
      src="https://player.twitch.tv/?channel=${encodeURIComponent(TWITCH_CHANNEL)}&parent=${window.location.hostname}"
      frameborder="0"
      allowfullscreen="true"
      scrolling="no"
      height="360"
      width="100%">
    </iframe>
  `;
  shell.innerHTML = embed;
}

async function initLiveTwitch() {
  try {
    const liveData = await fetchTwitchLive();
    renderTwitchLive(liveData);
  } catch (e) {
    console.error("Errore live Twitch:", e);
  }
}

/* ========= TIMELINE ========= */
function buildTimeline(last) {
  const container = document.getElementById("dot-timeline");
  if (!container) return;

  const pulls = last?.pulls || [];
  if (!pulls.length) {
    container.innerHTML = "<p class=\"section-subtitle\">Nessun dato da mostrare.</p>";
    return;
  }

  const dots = pulls.map((pull, i) => {
    const isKill = pull.kill;
    const boss = pull.boss || "Boss";
    const pct = pull.kill ? "100%" : `${pull.bestPercentage ?? "–"}%`;
    const cls = isKill ? "dot dot-kill" : "dot dot-progress";
    return `
      <div class="timeline-dot" data-index="${i}">
        <div class="${cls}"></div>
        <div class="timeline-tooltip">
          <strong>${boss}</strong><br>
          ${isKill ? "Kill" : `Best ${pct}`}
        </div>
      </div>
    `;
  }).join("");

  container.innerHTML = `<div class="dot-timeline">${dots}</div>`;
}

/* ========= SESSION SUMMARY ========= */
function renderSessionSummary(last) {
  const container = document.getElementById("last-session-summary");
  if (!container) return;

  if (!last || !last.session) {
    container.textContent = "Nessuna sessione disponibile.";
    return;
  }

  const { session } = last;
  const date = session.date || "Data non disponibile";
  const duration = session.duration || "—";
  const kills = session.kills ?? 0;
  const wipes = session.wipes ?? 0;
  const best = session.bestPercent != null ? `${session.bestPercent}%` : "—";

  container.innerHTML = `
    <h3 class="widget-title">Riassunto sessione</h3>
    <p><strong>Data:</strong> ${date}</p>
    <p><strong>Durata:</strong> ${duration}</p>
    <p><strong>Kill:</strong> ${kills}</p>
    <p><strong>Wipe:</strong> ${wipes}</p>
    <p><strong>Miglior try:</strong> ${best}</p>
  `;
}

/* ========= REPORT LINK ========= */
function renderReportLink(last) {
  const link = document.getElementById("last-session-report-link");
  if (!link) return;

  const url = last?.reportURL;
  if (!url) return;

  link.href = url;
  link.classList.remove("hidden");
}

/* ========= ROSTER ========= */
/* ========= ROSTER ULTIMO PULL ========= */
function extractLastPullRoster(last) {
  const pulls = last?.pulls || [];
  if (!pulls.length) return [];

  const latest = pulls
    .slice()
    .reverse()
    .find(p => p.friendlyPlayers && p.friendlyPlayers.length);

  return latest ? latest.roster : [];
}

function renderRoster(last) {
  const container = document.getElementById("live-roster");
  if (!container) return;

  const pullRoster = extractLastPullRoster(last);

  if (!pullRoster.length) {
    container.textContent = "Nessun roster trovato nell’ultimo pull.";
    return;
  }

  const enriched = pullRoster.map(p => ({
    name: p.name,
    role: p.role || "",
    class: p.class || ""
  }));

  const html = enriched.map(p => {
    const role = p.role.toLowerCase();
    const roleClass =
      role === "tank" ? "roster-role-tank" :
      role === "healer" ? "roster-role-heal" :
      role === "dps" ? "roster-role-dps" : "";

    const icon = p.class
      ? `../../img/classes/${p.class.toLowerCase().replace(" ", "")}.png`
      : "";

    return `
      <div class="roster-item">
        <div class="roster-item-main">
          ${icon ? `<img src="${icon}" class="roster-class-icon">` : ""}
          <strong>${p.name}</strong>
          ${role ? `<span class="roster-role-tag ${roleClass}">${role}</span>` : ""}
        </div>
        <div class="roster-meta">
          <span>${p.class || "Classe sconosciuta"}</span>
          <span>${p.role || "Ruolo"}</span>
        </div>
      </div>
    `;
  }).join("");

  container.innerHTML = `<div class="roster-grid roster-grid--compact">${html}</div>`;
}

async function initProgressPage() {
  await Promise.all([
    loadDifficulty("normal", "card-normal"),
    loadDifficulty("heroic", "card-heroic"),
    loadDifficulty("mythic", "card-mythic")
  ]);

  try {
    const last = await fetchLastSession();
    buildTimeline(last);
    renderSessionSummary(last);
    renderReportLink(last);
    renderRoster(last);
  } catch (e) {
    console.error("Errore sessione:", e);
    const roster = document.getElementById("live-roster");
    if (roster) roster.textContent = "Errore nel caricare il roster.";
  }

  initLiveTwitch();
}

initProgressPage();
</script>

</body>
</html>
