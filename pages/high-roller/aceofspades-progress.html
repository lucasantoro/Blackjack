<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Ace of Spades – Progress</title>
  <link rel="stylesheet" href="../../css/style.css">
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">
</head>

<body class="page-transition blackjack-bg">

<header>
  <nav class="mainnav">
    <ul>
      <li><a href="../../index.html">Home</a></li>
      <li><a href="../raider.html">Raider</a></li>
      <li><a href="../hollowsoul.html">Hollow Soul</a></li>
      <li><a href="../recruiting.html">Reclutamento</a></li>
      <li><a href="../statuto.html">Statuto</a></li>
    </ul>
  </nav>
</header>

<!-- SUBNAV ACE OF SPADES -->
<nav class="subnav">
  <ul>
    <li><a href="../high-roller/aceofspades.html">Home Team</a></li>
    <li><a href="../high-roller/roster-aceofspades.html">Roster</a></li>
    <li><a href="../high-roller/aceofspades-news.html">News</a></li>
    <li><a href="../high-roller/aceofspades-progress.html" class="active">Progress</a></li>
  </ul>
</nav>

<section class="hero">
  <div class="hero-content">
    <h2>Progress Ace of Spades</h2>
    <p>Avanzamento raid, recap sessioni e roster dell’ultima serata.</p>
  </div>
</section>

<div class="bg-container bg-aceofspades-logo">
  <main class="panel">

    <!-- PANORAMICA -->
    <h2 class="section-title">Panoramica per difficoltà</h2>
    <p class="section-subtitle">
      Stato del raid per Normal, Heroic e Mythic.
    </p>

    <div class="widgets-grid">

      <div class="widget-card">
        <h3 class="widget-title">Normal</h3>
        <div class="progress-content" id="card-normal">Caricamento…</div>
      </div>

      <div class="widget-card">
        <h3 class="widget-title">Heroic</h3>
        <div class="progress-content" id="card-heroic">Caricamento…</div>
      </div>

      <div class="widget-card">
        <h3 class="widget-title">Mythic</h3>
        <div class="progress-content" id="card-mythic">Caricamento…</div>
      </div>

    </div>

    <!-- ULTIMA SESSIONE -->
    <div class="widget-full">
      <h2 class="section-title" id="last-session-title">
        Ultima sessione raid
      </h2>
      <p class="section-subtitle">
        Resoconto completo della serata Ace of Spades: kill, wipe e progress.
        Passa col mouse sui pallini per vedere i dettagli.
      </p>

      <!-- LIVE TWITCH -->
      <div id="live-raid-wrapper" class="live-raid-wrapper">
        <div class="live-raid-card" id="live-raid-card">
          <div class="live-status-pill live-status-offline" id="live-status-pill">
            <span class="live-dot"></span> Offline
          </div>
          <h3 class="widget-title">Diretta raid – Twitch</h3>
          <p class="live-description" id="live-description">
            La diretta verrà mostrata qui quando il canale sarà online.
          </p>
          <div class="live-player-shell" id="live-player-shell">
            <!-- iframe Twitch verrà inserito via JS -->
          </div>
        </div>
      </div>
      <!-- /LIVE TWITCH -->

      <div class="session-summary-card" id="last-session-summary">
        Caricamento…
      </div>

      <div class="dot-timeline-container" id="dot-timeline"></div>

      <div class="text-center mt-20">
        <a id="last-session-report-link"
           href="#"
           target="_blank"
           class="apply-button hidden">
          Apri il report dell’ultima sessione
        </a>
      </div>

      <!-- ROSTER DALL'ULTIMO REPORT -->
      <div class="session-roster-card" id="live-roster-card">
        <h3 class="widget-title">Roster attuale</h3>
        <p class="section-subtitle section-subtitle--compact">
          Giocatori presenti nell’ultima sessione registrata su Warcraft Logs.
        </p>
        <div id="live-roster">Caricamento roster…</div>
      </div>

    </div>

  </main>
</div>

<footer>
  <p>&copy; 2025 Blackjack</p>
</footer>

<!-- TRANSITION -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  document.body.classList.add("page-loaded");
});
</script>

<!-- URL WORKERS -->
<script>
  const WORKER_FULL = "https://red-snowflake-a386.lucasantoro2905.workers.dev";
  const WORKER_LAST = "https://wild-mode-1b45.lucasantoro2905.workers.dev";

  /* LIVE TWITCH */
  const TWITCH_CHANNEL = "londe83";
  const WORKER_TWITCH = "https://tiny-fog-34d1.lucasantoro2905.workers.dev"; // cambia se usi un altro URL
</script>

<!-- PROGRESS LOGIC -->
<script>
async function loadDifficulty(diff, id) {
  try {
    const el = document.getElementById(id);
    const res = await fetch(`${WORKER_FULL}/progress-full?difficulty=${diff}`);
    const data = await res.json();

    const bosses = Object.keys(data.bosses || {});
    const killed = bosses.filter(b => data.bosses[b].kills > 0);
    const inProgress = bosses.filter(
      b => data.bosses[b].kills === 0 &&
           data.bosses[b].bestPercentage != null &&
           data.bosses[b].bestPercentage < 100
    );

    let html = `
      <strong>Kill:</strong> ${killed.length} / ${bosses.length}<br>
      <strong>Progress:</strong> ${inProgress.length}<br>
      <strong>Miglior try:</strong>
      ${inProgress.length ? Math.min(...inProgress.map(b => data.bosses[b].bestPercentage)) + "%" : "—"}
      <div class="boss-list">
    `;

    killed.forEach(b => html += `<span class="boss-killed">${b}</span>`);
    inProgress.forEach(b => html += `<span class="boss-progress">${b} (${data.bosses[b].bestPercentage}%)</span>`);

    html += "</div>";
    el.innerHTML = html;

  } catch (e) {
    document.getElementById(id).textContent = "Errore nel caricamento.";
  }
}

async function fetchLastSession() {
  const res = await fetch(`${WORKER_LAST}/progress-last`);
  return res.json();
}

/* ========= LIVE TWITCH ========= */
async function fetchTwitchLive() {
  const url = `${WORKER_TWITCH}/?channel=${encodeURIComponent(TWITCH_CHANNEL)}`;
  const res = await fetch(url, { cache: "no-store" });
  if (!res.ok) throw new Error("Errore worker Twitch");
  return res.json();
}

function renderTwitchLive(liveData) {
  const pill = document.getElementById("live-status-pill");
  const descr = document.getElementById("live-description");
  const shell = document.getElementById("live-player-shell");
  if (!pill || !descr || !shell) return;

  if (!liveData || !liveData.live) {
    pill.classList.remove("live-status-live");
    pill.classList.add("live-status-offline");
    pill.innerHTML = '<span class="live-dot"></span> Offline';
    descr.textContent = "Il canale Twitch è attualmente offline. La prossima diretta raid verrà mostrata qui appena saremo live.";
    shell.innerHTML = "";
    return;
  }

  pill.classList.remove("live-status-offline");
  pill.classList.add("live-status-live");
  pill.innerHTML = '<span class="live-dot"></span> Live ora';

  const title = liveData.title || "Diretta raid Ace of Spades";
  const game = liveData.game_name;
  const viewers = liveData.viewer_count;

  let descText = title;
  if (game) descText += ` • Giocando: ${game}`;
  if (viewers != null) descText += ` • Viewers: ${viewers}`;
  descr.textContent = descText;

  const parent = window.location.hostname;
  const embedUrl =
    `https://player.twitch.tv/?channel=${encodeURIComponent(TWITCH_CHANNEL)}&parent=${encodeURIComponent(parent)}`;

  shell.innerHTML = `
    <iframe
      src="${embedUrl}"
      allowfullscreen="true"
      scrolling="no"
      allow="autoplay; fullscreen">
    </iframe>
  `;
}

/* ========= ROSTER ========= */
/* ========= ROSTER ULTIMO PULL ========= */

function classIcon(className) {
  if (!className) return "";
  const cl = className.toLowerCase().replace(/\s+/g, "");
  return `../../img/classes/${cl}.png`; 
}

function extractLastPullRoster(last) {
  if (!last || !last.bosses) return [];

  let latest = null;

  // Trova il pull più recente tra tutti i boss
  for (const boss of Object.values(last.bosses)) {
    if (!boss.pullsDetail) continue;

    boss.pullsDetail.forEach((p, idx) => {
      if (!p) return;

      const timestamp = p.end || p.start || 0;

      if (!latest || timestamp > latest.timestamp) {
        latest = {
          roster: p.friendlyPlayers || [],
          timestamp
        };
      }
    });
  }

  return latest ? latest.roster : [];
}

function roleFromSpecSafe(spec) {
  if (!spec) return "";
  const s = spec.toLowerCase();

  if (s.includes("protection") || s.includes("blood") || s.includes("guardian"))
    return "tank";

  if (s.includes("holy") || s.includes("restoration") || s.includes("disc") || s.includes("disci"))
    return "healer";

  return "dps";
}

function renderRoster(last) {
  const container = document.getElementById("live-roster");
  if (!container) return;

  const pullRoster = extractLastPullRoster(last);

  if (!pullRoster.length) {
    container.textContent = "Nessun roster trovato nell’ultimo pull.";
    return;
  }

  // Arricchisci i dati
  const enriched = pullRoster.map(p => ({
    name: p.name,
    class: p.class || p.icon || "",
    spec: p.spec || "",
    role: roleFromSpecSafe(p.spec)
  }));

  // Ordine per ruolo
  const order = { tank: 0, healer: 1, dps: 2 };
  enriched.sort((a, b) => {
    const ra = order[a.role] ?? 99;
    const rb = order[b.role] ?? 99;
    if (ra !== rb) return ra - rb;
    return a.name.localeCompare(b.name);
  });

  const html = enriched.map(p => {
    const icon = classIcon(p.class);
    const role = p.role || "";
    const roleClass =
      role === "tank" ? "roster-role-tank" :
      role === "healer" ? "roster-role-heal" :
      role === "dps" ? "roster-role-dps" : "";

    return `
      <div class="roster-item">
        <div class="roster-item-main">
          <img src="${icon}" class="roster-class-icon">
          ${p.name}
          <span class="roster-role-tag ${roleClass}">${role}</span>
        </div>
        <div class="roster-meta">
          ${p.class} – ${p.spec}
        </div>
      </div>
    `;
  }).join("");

  container.innerHTML = `<div class="roster-grid roster-grid--compact">${html}</div>`;
}


/* ========= TIMELINE A PALLINI ========= */

function diffLabel(diff) {
  switch (diff) {
    case 3: return "Normal";
    case 4: return "Heroic";
    case 5: return "Mythic";
    default: return diff != null ? `Diff ${diff}` : "Sconosciuta";
  }
}

function renderLastSessionTimeline(last) {
  const timeline = document.getElementById("dot-timeline");
  const summary = document.getElementById("last-session-summary");
  const bosses = Object.values(last.bosses || {});

  if (!bosses.length) {
    summary.innerHTML = "Nessun dato.";
    return;
  }

  // summary
  const pulls = bosses.reduce((s,b)=>s+b.pulls,0);
  const wipes = bosses.reduce((s,b)=>s+b.wipes,0);
  const kills = bosses.reduce((s,b)=>s+b.kills,0);

  summary.innerHTML = `
    <strong>Boss:</strong> ${bosses.length}<br>
    <strong>Pull totali:</strong> ${pulls}<br>
    <strong>Wipe totali:</strong> ${wipes}<br>
    <strong>Kill totali:</strong> ${kills}
  `;

  // link report
  if (last.latestReport?.code) {
    const a = document.getElementById("last-session-report-link");
    a.href = `https://www.warcraftlogs.com/reports/${last.latestReport.code}`;
    a.classList.remove("hidden");
  }

  timeline.innerHTML = "";
  bosses.sort((a,b)=>a.bossName.localeCompare(b.bossName));

  bosses.forEach(b => {

    const row = document.createElement("div");
    row.className = "dot-row";

    row.innerHTML = `<div class="dot-boss-name">${b.bossName}</div>`;

    const line = document.createElement("div");
    line.className = "dot-line";

    for (let i = 0; i < b.pulls; i++) {

      const d = document.createElement("div");
      let cls = "dot-wipe";

      const pullNumber = i + 1;
      const isKill = (i === b.pulls - 1 && b.kills > 0);
      const isBest = (b.bestPullIndex === i);

      const parts = [];

      if (isKill) {
        parts.push(`KILL – Pull #${pullNumber}`);
      } else if (isBest) {
        parts.push(`Best try – ${b.bestPercentage}% – Pull #${pullNumber}`);
      } else {
        parts.push(`Wipe – Pull #${pullNumber}`);
      }

      // Difficoltà (da pullsDetail se presente, altrimenti da difficultiesSeen)
      const detail = b.pullsDetail && b.pullsDetail[i];
      let diff = detail ? detail.difficulty : null;
      if (diff == null && Array.isArray(b.difficultiesSeen) && b.difficultiesSeen.length) {
        diff = b.difficultiesSeen[0];
      }
      if (diff != null) {
        parts.push(`Difficoltà: ${diffLabel(diff)}`);
      }

      // HP rimanente
      if (!isKill && b.hpPercentHistory && b.hpPercentHistory[i] != null) {
        parts.push(`HP boss: ${b.hpPercentHistory[i]}%`);
      }

      // Durata (in secondi) se presente: b.pullDurations[i]
      if (b.pullDurations && b.pullDurations[i] != null) {
        const sec = b.pullDurations[i];
        const m = Math.floor(sec / 60);
        const s = sec % 60;
        const durStr = m > 0 ? `${m}m ${s}s` : `${s}s`;
        parts.push(`Durata: ${durStr}`);
      }

      let tip = parts.join(" • ");

      // classi colore
      if (isKill) {
        cls = "dot-kill";
      } else if (isBest) {
        cls = "dot-progress";
      } else {
        cls = "dot-wipe";
      }

      d.className = `dot ${cls}`;
      d.setAttribute("data-tip", tip);

      // link al pull
      if (b.fightIDs && b.fightIDs[i] != null && last.latestReport?.code) {
        const reportCode = last.latestReport.code;
        const fightID = b.fightIDs[i];

        d.style.cursor = "pointer";
        d.addEventListener("click", () => {
          window.open(
            `https://www.warcraftlogs.com/reports/${reportCode}#fight=${fightID}`,
            "_blank"
          );
        });
      }

      line.appendChild(d);
    }

    row.appendChild(line);
    timeline.appendChild(row);
  });
}

/* ========= INIT ========= */
(async () => {
  loadDifficulty("normal", "card-normal");
  loadDifficulty("heroic", "card-heroic");
  loadDifficulty("mythic", "card-mythic");

  try {
    const last = await fetchLastSession();
    renderLastSessionTimeline(last);
    renderRoster(last);
  } catch (e) {
    document.getElementById("last-session-summary").textContent =
      "Errore nel caricare l'ultima sessione.";
    const roster = document.getElementById("live-roster");
    if (roster) roster.textContent = "Errore nel caricare il roster.";
  }

  // LIVE TWITCH
  try {
    const live = await fetchTwitchLive();
    renderTwitchLive(live);
  } catch (e) {
    console.error(e);
    const d = document.getElementById("live-description");
    if (d) d.textContent = "Impossibile controllare lo stato della live Twitch.";
  }
})();
</script>

</body>
</html>
