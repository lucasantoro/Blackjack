<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Blackjack – Video divertenti</title>
  <link rel="stylesheet" href="../css/style.css">
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">
</head>

<body class="page-transition blackjack-bg">

<header>
  <nav class="mainnav">
    <ul>
      <li><a href="../index.html">Home</a></li>
      <li><a href="raider.html">Raider</a></li>
      <li><a href="hollowsoul.html">Spettatori</a></li>
      <li><a href="recruiting.html">Reclutamento</a></li>
      <li><a href="statuto.html">Statuto</a></li>
    </ul>
  </nav>
</header>

<nav class="subnav">
  <ul>
    <li><a href="hollowsoul.html">Community</a></li>
    <li><a href="hollowsoul-video.html" class="active">Video divertenti</a></li>
    <li><a href="hollowsoul-eventi.html">Eventi di gilda</a></li>
  </ul>
</nav>

<section class="hero">
  <div class="hero-content">
    <h2>Video divertenti della gilda</h2>
    <p>
      Clip leggere, wipe epici e momenti da ridere insieme: il lato più creativo degli Spettatori.
    </p>
  </div>
</section>

<div class="bg-container bg-main-logo">
  <main class="panel">

    <h2 class="section-title">La nostra videoteca</h2>
    <p class="section-subtitle">
      Un carosello aggiornato automaticamente con gli Shorts del canale @admin1 che
      contengono la parola “[Blackjack]”.
    </p>

    <div class="media-carousel-wrapper">
      <button class="carousel-nav carousel-prev" type="button" aria-label="Scorri a sinistra">
        &#x2039;
      </button>
      <div class="media-carousel" id="youtube-carousel" data-channel-handle="@admin1">
        <p class="media-status">Caricamento degli Shorts...</p>
      </div>
      <button class="carousel-nav carousel-next" type="button" aria-label="Scorri a destra">
        &#x203A;
      </button>
    </div>

  </main>
</div>

<footer>
  <p>&copy; 2025 Blackjack</p>
</footer>

<script>
document.addEventListener("DOMContentLoaded", () => {
  document.body.classList.add("page-loaded");
});

document.querySelectorAll("a").forEach(link => {
  if (link.hostname === window.location.hostname) {
    link.addEventListener("click", event => {
      event.preventDefault();
      const href = link.getAttribute("href");
      document.body.classList.remove("page-loaded");
      setTimeout(() => { window.location.href = href; }, 300);
    });
  }
});

const carousel = document.getElementById("youtube-carousel");
const statusMessage = carousel?.querySelector(".media-status");
const CHANNEL_HANDLE = carousel?.dataset.channelHandle || "@admin1/shorts";
const KEYWORD = "[Blackjack]";
const CHANNEL_PAGE_HANDLE = CHANNEL_HANDLE.replace(/\/.*$/, "");

const escapeHtml = (value) =>
  value.replace(/[&<>"']/g, (char) => ({
    "&": "&amp;",
    "<": "&lt;",
    ">": "&gt;",
    "\"": "&quot;",
    "'": "&#39;"
  })[char]);

const formatDate = (value) => {
  const date = new Date(value);
  if (Number.isNaN(date.getTime())) {
    return "";
  }
  return date.toLocaleDateString("it-IT", {
    day: "2-digit",
    month: "long",
    year: "numeric"
  });
};

const renderStatus = (message) => {
  if (statusMessage) {
    statusMessage.textContent = message;
  }
};

const renderVideoCard = ({ title, description, published, videoId }) => {
  const article = document.createElement("article");
  article.className = "media-card";

  const player = document.createElement("div");
  player.className = "media-player";
  player.innerHTML = `
    <iframe
      src="https://www.youtube.com/embed/${videoId}"
      title="${escapeHtml(title)}"
      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
      allowfullscreen>
    </iframe>
  `;

  const heading = document.createElement("h3");
  heading.textContent = title;

  const meta = document.createElement("p");
  meta.className = "media-meta";
  meta.textContent = published ? `Pubblicato il ${published}` : "";

  const body = document.createElement("p");
  body.textContent = description || "Descrizione non disponibile.";

  article.append(player, heading, meta, body);
  return article;
};

const extractVideoId = (entryId) => {
  const match = /yt:video:([\w-]+)/.exec(entryId);
  return match ? match[1] : "";
};

const fetchChannelId = async () => {
  const url = `https://r.jina.ai/http://www.youtube.com/${CHANNEL_PAGE_HANDLE}`;
  const response = await fetch(url);
  if (!response.ok) {
    throw new Error("Impossibile raggiungere il canale YouTube.");
  }
  const text = await response.text();
  const match = text.match(/\"channelId\":\"(UC[^\"]+)\"/);
  if (!match) {
    throw new Error("Channel ID non trovato.");
  }
  return match[1];
};

const fetchVideos = async (channelId) => {
  const feedUrl = `https://r.jina.ai/http://www.youtube.com/feeds/videos.xml?channel_id=${channelId}`;
  const response = await fetch(feedUrl);
  if (!response.ok) {
    throw new Error("Feed YouTube non disponibile.");
  }
  const xmlText = await response.text();
  const parser = new DOMParser();
  const xml = parser.parseFromString(xmlText, "text/xml");
  const entries = Array.from(xml.querySelectorAll("entry"));

  return entries
    .map((entry) => ({
      title: entry.querySelector("title")?.textContent?.trim() || "Video",
      description: entry.querySelector("media\\:description")?.textContent?.trim() || "",
      published: entry.querySelector("published")?.textContent || "",
      videoId: extractVideoId(entry.querySelector("id")?.textContent || "")
    }))
    .filter((item) => item.videoId)
    .filter((item) => {
      const haystack = `${item.title} ${item.description}`.toLowerCase();
      return haystack.includes(KEYWORD.toLowerCase());
    });
};

const updateNavState = () => {
  const prevButton = document.querySelector(".carousel-prev");
  const nextButton = document.querySelector(".carousel-next");
  if (!carousel || !prevButton || !nextButton) return;
  const maxScroll = carousel.scrollWidth - carousel.clientWidth;
  prevButton.disabled = carousel.scrollLeft <= 0;
  nextButton.disabled = carousel.scrollLeft >= maxScroll - 1;
};

const loadYoutubeCarousel = async () => {
  if (!carousel) return;
  try {
    const channelId = await fetchChannelId();
    const videos = await fetchVideos(channelId);
    carousel.innerHTML = "";

    if (!videos.length) {
      renderStatus("Nessun video con la parola “blackjack” trovato.");
      carousel.append(statusMessage);
      return;
    }

    videos.forEach((video) => {
      const card = renderVideoCard({
        ...video,
        published: formatDate(video.published)
      });
      carousel.append(card);
    });
    updateNavState();
  } catch (error) {
    carousel.innerHTML = "";
    renderStatus("Impossibile caricare i video in questo momento.");
    carousel.append(statusMessage);
    console.error(error);
  }
};

loadYoutubeCarousel();

const scrollCarousel = (direction) => {
  if (!carousel) return;
  const card = carousel.querySelector(".media-card");
  const scrollAmount = card ? card.offsetWidth + 20 : 320;
  carousel.scrollBy({ left: direction * scrollAmount, behavior: "smooth" });
};

document.querySelector(".carousel-prev")?.addEventListener("click", () => {
  scrollCarousel(-1);
});

document.querySelector(".carousel-next")?.addEventListener("click", () => {
  scrollCarousel(1);
});

carousel?.addEventListener("scroll", () => {
  window.requestAnimationFrame(updateNavState);
});

window.addEventListener("resize", updateNavState);
</script>

</body>
</html>
